name: Generate hotspots from satellite API and upload to Azure

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.11
          auto-activate-base: false
          channels: conda-forge,defaults

      - name: Create conda env with compatible geostack
        run: |
          conda create -n gh-env -y \
            python=3.11 \
            rasterio=1.3.10 \
            pyproj=3.6 \
            numpy \
            netcdf4

          conda run -n gh-env pip install planetary-computer pystac-client

          conda run -n gh-env python - <<'EOF'
          import rasterio
          import pyproj
          import planetary_computer
          import pystac_client
          print("rasterio:", rasterio.__version__)
          print("pyproj:", pyproj.__version__)
          print("planetary-computer: OK")
          print("pystac-client: OK")
          EOF

      - name: Run generator
        run: |
          conda run -n gh-env python data/processing/make_hotspots_from_api.py

      - name: Upload generated GeoJSON to Azure ($web/data) using azcopy (SAS)
        shell: bash
        run: |
          set -e
          curl -L https://aka.ms/downloadazcopy-v10-linux | tar -xz
          AZCOPY=$(find . -type f -name azcopy | head -n 1)
          chmod +x "$AZCOPY"

          SAS="${{ secrets.AZURE_STORAGE_SAS }}"
          if [[ "$SAS" != \?* ]]; then
            SAS="?$SAS"
          fi

          CONTAINER_URL="https://${{ secrets.AZURE_STORAGE_ACCOUNT }}.blob.core.windows.net/%24web?${{SAS}}"

          "$AZCOPY" copy "data/hotspots_*.geojson" "${CONTAINER_URL}/data/" --overwrite=true
