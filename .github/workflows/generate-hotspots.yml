name: Generate hotspots from satellite API and upload to Azure

on:
  push:
    branches:
      - master
  workflow_dispatch: {}

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: 3.11
          auto-activate-base: false

      - name: Create conda env with compatible rasterio / pyproj / numpy
        run: |
          # tworzymy środowisko conda z kompatybilnym rasterio i pyproj
          conda create -n gh-env -y python=3.11 rasterio=1.3.10 pyproj=3.6 numpy
          # instalacja paczek z pip wewnątrz środowiska conda
          conda run -n gh-env pip install planetary-computer pystac-client
          # test pakietów
          conda run -n gh-env python -c "import rasterio; print('rasterio', rasterio.__version__); import pyproj; print('pyproj', pyproj.__version__); import planetary_computer; print('planetary_computer OK'); import pystac_client; print('pystac_client OK')"

      - name: Run generator
        run: |
          # uruchamiamy skrypt w środowisku conda
          conda run -n gh-env python data/processing/make_hotspots_from_api.py

      - name: Upload generated GeoJSON to Azure ($web/data) using azcopy (SAS)
        shell: bash
        run: |
          set -e
          curl -L https://aka.ms/downloadazcopy-v10-linux | tar -xz
          AZCOPY=$(find . -type f -name azcopy | head -n 1)
          chmod +x "$AZCOPY"

          SAS="${{ secrets.AZURE_STORAGE_SAS }}"
          if [[ "$SAS" != \?]()]()
